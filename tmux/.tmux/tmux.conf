# ==========================
# ===  General settings  ===
# ==========================

set -g default-terminal "screen-256color"
set -g history-limit 20000
set -sg escape-time 0
set -g display-time 1500
set -g remain-on-exit off
set -g repeat-time 300
setw -g allow-rename off
setw -g automatic-rename off
setw -g aggressive-resize on

# Prefix key: C-a
unbind C-b
set -g prefix C-a

# Terminal title
set -g set-titles on
set -g set-titles-string "#I:#W"

# 1-based indexing
set -g base-index 1
setw -g pane-base-index 1

# Mouse
set -g mouse on

# ==========================
# ===   Key bindings     ===
# ==========================

# Unbind defaults we override
unbind "\$" # rename-session
unbind ,    # rename-window
unbind %    # split-window -h
unbind '"'  # split-window
unbind [    # paste-buffer
unbind ]
unbind "'"  # select-window
unbind l    # last-window
unbind M-n  # next window with alert
unbind M-p  # next window with alert
unbind o    # focus thru panes
unbind &    # kill-window
unbind "#"  # list-buffer
unbind =    # choose-buffer
unbind z    # zoom-pane
unbind M-Up
unbind M-Down
unbind M-Right
unbind M-Left

# Edit configuration and reload
bind C-e new-window -n 'tmux.conf' "sh -c '\${EDITOR:-vim} ~/.tmux.conf && tmux source ~/.tmux.conf && tmux display \"Config reloaded\"'"

# Reload tmux configuration
bind C-c source-file ~/.tmux.conf \; display "Config reloaded"

# New session / new window (retain cwd)
bind C command-prompt -p "New session name:" "new-session -s '%%'"
bind c new-window -c "#{pane_current_path}"

# Prompt to rename window right after creation
set-hook -g after-new-window 'command-prompt -I "#{window_name}" "rename-window '%%'"'

# Rename session and window
bind r command-prompt -I "#{window_name}" "rename-window '%%'"
bind R command-prompt -I "#{session_name}" "rename-session '%%'"

# Split panes
bind | split-window -h -c "#{pane_current_path}"
bind _ split-window -v -c "#{pane_current_path}"

# Select pane and windows
bind -r p previous-window
bind -r n next-window
bind -r [ select-pane -t :.-
bind -r ] select-pane -t :.+
bind -r Tab last-window
bind -r C-o swap-pane -D

# Zoom pane
bind + resize-pane -Z

# Link window
bind L command-prompt -p "Link window from (session:window): " "link-window -s %% -a"

# Swap panes back and forth with 1st pane
bind '\' if '[ #{pane_index} -eq 1 ]' \
     'swap-pane -s "!"' \
     'select-pane -t:.1 ; swap-pane -d -t 1 -s "!"'

# Kill pane/window/session
bind x kill-pane
bind X kill-window
bind C-x confirm-before -p "kill other windows? (y/n)" "kill-window -a"
bind Q confirm-before -p "kill-session #S? (y/n)" kill-session

# Merge session with another one
bind C-u command-prompt -p "Session to merge with: " \
   "run-shell 'yes | head -n #{session_windows} | xargs -I {} -n 1 tmux movew -t %%'"

# Detach
bind d detach
bind D if -F '#{session_many_attached}' \
    'confirm-before -p "Detach other clients? (y/n)" "detach -a"' \
    'display "Session has only 1 client attached"'

# Toggle status bar
bind C-s if -F '#{s/off//:status}' 'set status off' 'set status on'

# ==========================
# === Prefix-free (Alt)  ===
# ==========================

# Windows
bind -n M-c new-window -c "#{pane_current_path}"
bind -n M-C command-prompt -p "New session name:" "new-session -s '%%'"
bind -n M-n next-window
bind -n M-p previous-window
bind -n M-Tab last-window

# Panes
bind -n M-| split-window -h -c "#{pane_current_path}"
bind -n M-_ split-window -v -c "#{pane_current_path}"
bind -n M-S-Left select-pane -L
bind -n M-S-Right select-pane -R
bind -n M-S-Up select-pane -U
bind -n M-S-Down select-pane -D
bind -n M-+ resize-pane -Z

# Sessions
bind -n M-s choose-tree -Zs
bind -n M-` switch-client -l
bind -n M-d detach

# ==========================
# ===     Status bar     ===
# ==========================

set -g status on
set -g status-interval 5
set -g status-position top
set -g status-justify left
set -g status-style "fg=colour245,bg=colour232"

set -g status-left "#[fg=colour39] #S #[default]"
set -g status-right "#[fg=colour166]%b %d %H:%M#[default]"

set -g window-status-separator ""
setw -g window-status-format " #I:#W "
setw -g window-status-current-style "fg=white,bold,bg=colour166"
setw -g window-status-current-format "#[fg=colour232,bg=colour166] #I:#W "

set -g mode-style "fg=default,bg=colour166"
set -g message-style "fg=colour166,bg=colour232"
setw -g pane-active-border-style "fg=colour166"
set -g window-style "fg=colour250,bg=colour235"
set -g window-active-style "fg=colour255,bg=colour233"

# ==========================
# ===       Plugins      ===
# ==========================

set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin 'tmux-plugins/tmux-continuum'

set -g @continuum-restore 'on'

# Initialize TPM
run '~/.tmux/plugins/tpm/tpm'
